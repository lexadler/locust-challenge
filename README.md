# locust-challenge

## Pre-requisites
1. **Python 3.10+ is installed**
2. **(Optional) Git LFS intalled**  
   Required to fetch the test credentials archive `credentials.zip` (for the authentication flow) with git
   ```bash
   git lfs install
   ```
   Alternatively, you can manually download the archive using the [following link](https://github.com/lexadler/locust-challenge/raw/refs/heads/master/credentials.zip).
3. **Clone the repository**
   ```bash
   git clone git@github.com:lexadler/locust-challenge.git
   cd locust-challenge
   ```
4. **Create and activate virtual environment in the project directory**
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows use `venv\Scripts\activate`
   ```
5. **(Optional) Install Poetry**
   ```bash
   python -m pip install --upgrade pip wheel setuptools  # Update Python package management tools
   pip install poetry  # Install Poetry
   ```
6. **Install project dependencies (excluding linting tools)**  
   Using Poetry
   ```bash
   poetry install --without lint
   ```  
   or pip
   ```bash
   pip install -r requirements.txt
   ```
7. **(Optional) Compile protobuf files via script**  
   Autogenerated files are included, but if .proto files are updated, the script will automatically "compile" all the protos and fix all the imports to be relative after running grpc_tools.protoc, so no manual changes are needed.
   ```bash
   poetry run python tools/generate_pb.py
   ```
8. **Extract or create a .json file with test credentials**  
   (Optional) Extract the test credentials from the archive `credentials.zip` to the `credentials/` directory (password required).  
   Alternatively, you can manually create the `credentials/credentials.json` file using the [schema provided](credentials/credentials.schema.json).

## Usage
Run Locust in standard UI mode:
```bash
locust
```
For more configuration options (like headless mode) and advanced usage, feel free to refer to the [official documentation](https://docs.locust.io/en/stable/).

## Test Scenario Flow

This project defines a gRPC-based load testing scenario using Locust. The test user authenticates using a random set of test credentials and performs both background and periodic CRUD operations against the VacancyService.

1. **Authentication (on user start)**  
   Upon user initialization:
   - A random set of credentials is loaded from `credentials.json`.  
     > These are dummy test credentials, not sensitive or production-bound.
   - A `SignInUserInput` is sent to the `AuthService` using the selected credentials.
   - The response contains an access token, which is extracted and used to emulate an authentication.
   - All subsequent gRPC requests from this user attach the token as an `authorization` header via gRPC metadata:
   > Token acquisition is a one-time step per user and occurs before any other RPCs are performed.

2. **CRUD flow (every 30 seconds)**  
   Every 30 seconds, each user performs a full CRUD cycle:
   - **Create** a vacancy with a random title, division, and country.
   - **Update** the vacancy's description.
   - **Read** the vacancy by ID.
   - **Delete** the vacancy by ID.

3. **Background vacancy fetch (every 45 seconds)**  
   Every 45 seconds, a new background task is spawned to fetch the full list of available vacancies from the server via `GetVacancies`.  
   > Fetch jobs are not queued — a new greenlet starts every 45 seconds regardless of the duration of previous ones.  
   > All background greenlets are tracked and terminated when the Locust user stops.

4. **Request tracking**  
   All gRPC calls are intercepted by a custom interceptor that logs request type, method, response time, response size, and exceptions to Locust's metrics system.  
   The interceptor transparently handles unary and streaming RPCs.

> Both background and scheduled tasks use greenlets and are integrated into Locust’s lifecycle — ensuring clean shutdown and accurate request reporting.
